<html>
<head>
<title>LD46 - Stacker Slackers?</title>
<link rel="stylesheet" type="text/css" href="/style.css">
<script type="text/javascript">

const isCheckbox = element => element.type === 'checkbox';

const isValidElement = element => {
  return element.name && element.value;
};

const isValidValue = element => {
  return (!['checkbox', 'radio'].includes(element.type) || element.checked);
};

const clearValidity = elementName => {
  const list = document.getElementsByName(elementName);
  for (let el of list) {
    el.setCustomValidity('');
  }
};

const formToJSON = elements => [].reduce.call(elements, (data, element) => {
  if (isValidElement(element) && isValidValue(element)) {
    if (isCheckbox(element)) {
      data[element.name] = (data[element.name] || []).concat(element.value);
    } else {
      data[element.name] = element.value;
    }
  }
  return data;
}, {});

</script>
<script type="module">

import { PlayerState } from './common/PlayerState.js';

let contentDiv;

let playerState = PlayerState.UNREGISTERED;

const delayBetweenRefresh = 2000;

const pollStateFromServer = () => {
  return playerState === PlayerState.IN_GAME || playerState === PlayerState.REGISTERED;
}

const replacePage = (html) => {
  contentDiv.innerHTML = html;
}

const setStateFromResponse = (responseText, resetClient) => {
  const response = JSON.parse(responseText);
  if (resetClient && response.hasOwnProperty("pageContentHTML")) {
    replacePage(response.pageContentHTML);
  }
  if (response.hasOwnProperty("gameState")) {
    console.log("Received game state from server: " + response.gameState);
    playerState = PlayerState.IN_GAME;
    // TODO: Should update the game on the client based on the game state!
  } else if (response.hasOwnProperty("playerRegistered") && response.playerRegistered) {
    playerState = PlayerState.REGISTERED;
  }
  if (response.hasOwnProperty("notification")) {
    console.log(response.notification);
  }

  if (pollStateFromServer()) {
    setTimeout(() => pollState(false), delayBetweenRefresh);
  }
}

const errorListener = () => {
  console.warning("XMLHttpRequest error!");
  if (pollStateFromServer()) {
    setTimeout(() => pollState(true), delayBetweenRefresh);
  }
}

const pollState = (resetClient) => {
  var refreshReq = new XMLHttpRequest();
  function reqListener() {
    setStateFromResponse(refreshReq.responseText, resetClient);
  }

  refreshReq.addEventListener("load", reqListener);
  refreshReq.addEventListener("error", errorListener);
  refreshReq.open("GET", "/content");
  refreshReq.send();
}

window.postForm = (url, formElement, resetClient) => {
  post(url, formToJSON(formElement), resetClient);
}

window.post = (url, jsonData, resetClient) => {
  var postReq = new XMLHttpRequest();
  function reqListener() {
    setStateFromResponse(postReq.responseText, resetClient);
  }

  postReq.addEventListener("load", reqListener);
  postReq.addEventListener("error", errorListener);
  postReq.open("POST", url);
  postReq.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

  const jsonString = JSON.stringify(jsonData);
  postReq.send("jsonData=" + encodeURIComponent(jsonString));
}

const start = () => {
  contentDiv = document.getElementById("content");
  pollState(true);

    board = new Board();
    var canvas = document.createElement('canvas');
    canvas.width = 500;
    canvas.height = 300;
    ctx = canvas.getContext('2d');
    document.body.appendChild(canvas);
    board.init();
    board.draw();

}

start();
</script>
</head>
<body>
<div id="content"></div>
</body>
</html>
